import{c as g,a as b,i as v}from"./CzoHSiXM.js";const u="justice",m="governance",y="mycelix-core",_="identity",f="benefits";async function l(n,t,i,c){try{return await b({role_name:n,zome_name:t,fn_name:i,payload:c})}catch(o){return console.warn(`[CivicClient] Zome call failed: ${n}/${t}/${i}`,o),null}}function p(n){var t;return n?((t=n.entry)==null?void 0:t.Present)??null:null}async function D(n){const t=await l(_,"identity","get_my_profile",null),i=p(t),c=await l(y,"matl","get_my_reputation",null),o=await l(_,"credentials","get_my_credentials",null),a=await l(m,"delegation","get_delegations_from",n),r=(o||[]).map(d=>{const s=p(d);return s?{type:s.type,issuer:s.issuer,issuedAt:new Date(s.issued_at),expiresAt:s.expires_at?new Date(s.expires_at):void 0,verified:s.verified}:null}).filter(d=>d!==null),e=(a||[]).map(d=>{const s=p(d);return s?{domain:s.domain,delegateTo:s.delegate_to,delegatedAt:new Date(s.delegated_at),revocable:s.revocable}:null}).filter(d=>d!==null);return{id:`CIT-${n.slice(0,12)}`,did:(i==null?void 0:i.did)||`did:mycelix:${n.slice(0,16)}`,name:(i==null?void 0:i.name)||"Citizen",trustScore:(c==null?void 0:c.composite)??.5,memberSince:new Date((i==null?void 0:i.created_at)||Date.now()-365*24*60*60*1e3),verificationLevel:(i==null?void 0:i.verification_level)||"basic",credentials:r,delegations:e}}async function C(n){const t=[],i=await l(u,"cases","get_cases_by_party",n);if(i)for(const o of i){const a=p(o);if(a&&!["Closed","Resolved"].includes(a.status)){const r={Filing:10,Mediation:40,Arbitration:60,Appeal:80,Enforcement:90};t.push({id:a.id,type:"case",title:a.title,submittedAt:new Date(a.filed_at),estimatedCompletion:new Date(a.filed_at+30*24*60*60*1e3),status:a.phase.toLowerCase(),progress:r[a.phase]??50})}}const c=await l(f,"applications","get_my_applications",null);if(c)for(const o of c){const a=p(o);a&&a.status!=="completed"&&a.status!=="denied"&&t.push({id:a.id,type:"application",title:a.title,submittedAt:new Date(a.submitted_at),estimatedCompletion:new Date(a.submitted_at+14*24*60*60*1e3),status:a.status,progress:a.progress})}return t.sort((o,a)=>a.submittedAt.getTime()-o.submittedAt.getTime())}async function A(n,t=30){const i=[],c=Date.now()-t*24*60*60*1e3,o=await l(u,"cases","get_cases_by_party",n);if(o)for(const r of o){const e=p(r);if(e&&e.resolved_at&&e.resolved_at>c){const d=await l(u,"arbitration","get_decision",e.id),s=p(d);i.push({id:e.id,type:e.category,title:e.title,decidedAt:new Date(e.resolved_at),outcome:w((s==null?void 0:s.outcome)||e.status),explanation:(s==null?void 0:s.reasoning)||"Case resolved.",appealDeadline:s!=null&&s.appeal_deadline?new Date(s.appeal_deadline):void 0,algorithmUsed:"arbitration_v1",inputData:{category:e.category},outputScore:.8})}}const a=await l(f,"decisions","get_my_recent_decisions",{days:t});if(a)for(const r of a){const e=p(r);e&&e.decided_at>c&&i.push({id:e.id,type:"Benefit",title:e.title,decidedAt:new Date(e.decided_at),outcome:w(e.outcome),explanation:e.explanation,algorithmUsed:e.algorithm,inputData:{},outputScore:.75})}return i.sort((r,e)=>e.decidedAt.getTime()-r.decidedAt.getTime())}function w(n){switch(n==null?void 0:n.toLowerCase()){case"approved":case"resolved":case"complainantfavor":case"settled":return"approved";case"denied":case"dismissed":case"respondentfavor":return"denied";case"partial":case"split":default:return"partial"}}async function R(n){const t=await l(y,"matl","get_detailed_breakdown",n);if(!t)return null;const i=[{name:"Quality (PoGQ)",score:t.quality,weight:.4,explanation:"Quality of contributions verified through Proof-of-Gradient-Quality",improvementActions:["Submit high-quality proposals","Provide accurate information"]},{name:"Consistency",score:t.consistency,weight:.3,explanation:"Consistency of behavior across interactions",improvementActions:["Respond promptly to requests","Follow through on commitments"]},{name:"Cross-hApp Reputation",score:t.reputation,weight:.3,explanation:"Reputation aggregated from other Mycelix applications",improvementActions:["Participate in governance","Build positive track record"]}],c=(t.history||[]).map(o=>({date:new Date(o.timestamp),score:o.score,event:o.event,delta:o.delta}));return{overall:t.composite,components:i,history:c,byzantineTolerance:t.byzantine_tolerance,lastVerification:new Date(t.last_verified)}}async function T(n){var a;const t=[],i=Date.now(),c=await l(u,"arbitration","get_appealable_decisions",n);if(c)for(const r of c){const e=p(r);if(e&&e.appealable&&e.appeal_deadline&&e.appeal_deadline>i){const d=await l(u,"cases","get_case",e.case_id),s=p(d);t.push({id:e.id,title:(s==null?void 0:s.title)||"Decision",outcome:e.outcome,deadline:new Date(e.appeal_deadline),grounds:x(e.outcome),mediationAvailable:!0,restorativeOption:((a=e.remedies)==null?void 0:a.some(h=>h.type_==="Apology"))||!1})}}const o=await l(f,"decisions","get_appealable_decisions",null);if(o)for(const r of o){const e=p(r);e&&e.appeal_deadline>i&&t.push({id:e.id,title:e.title,outcome:e.outcome,deadline:new Date(e.appeal_deadline),grounds:e.grounds,mediationAvailable:!1,restorativeOption:!1})}return t.sort((r,e)=>r.deadline.getTime()-e.deadline.getTime())}function x(n){const t=["new_evidence","procedural_error","bias"];return n==="Dismissed"?[...t,"standing_dispute"]:t}async function E(){const n=await l(f,"credits","get_my_credits",null);return n?{balance:n.balance,monthlyAllocation:n.monthly_allocation,lastAllocation:new Date(n.last_allocation),expiresAt:new Date(n.expires_at),spentThisMonth:n.spent_this_month.map(t=>({amount:t.amount,recipient:t.recipient,purpose:t.purpose,timestamp:new Date(t.timestamp)}))}:null}async function L(){const n=await l(f,"benefits","get_my_active_benefits",null);return n?n.map(t=>{const i=p(t);return i?{id:i.id,name:i.name,type:i.type,status:i.status,value:i.value,renewalDate:i.renewal_date?new Date(i.renewal_date):void 0}:null}).filter(t=>t!==null):[]}async function O(n){const t=await l(m,"proposals","get_active_proposals_for_member",n);if(!t)return[];const i=[];for(const c of t){const o=p(c);if(!o||o.voting_ends<Date.now())continue;const a=await l(m,"voting","check_delegate_voted",{proposal_id:o.id,delegator:n});i.push({proposalId:o.id,title:o.title,deadline:new Date(o.voting_ends),yourDelegateVoted:a==null?void 0:a.voted,delegateName:a==null?void 0:a.delegate_name})}return i.sort((c,o)=>c.deadline.getTime()-o.deadline.getTime())}async function B(n){if(!v()&&!await g())return console.warn("[CivicClient] Could not connect to conductor"),null;console.log("[CivicClient] Loading live dashboard data for",n.slice(0,12)+"...");const[t,i,c,o,a,r,e,d]=await Promise.all([D(n),C(n),A(n,30),R(n),T(n),E(),L(),O(n)]);return t?{profile:t,pendingDecisions:i,recentDecisions:c,trustBreakdown:o||{overall:.5,components:[],history:[],byzantineTolerance:.34,lastVerification:new Date},appealableDecisions:a,civicCredits:r||{balance:0,monthlyAllocation:100,lastAllocation:new Date,expiresAt:new Date(Date.now()+30*24*60*60*1e3),spentThisMonth:[]},activeBenefits:e,upcomingVotes:d}:(console.warn("[CivicClient] Could not fetch citizen profile"),null)}async function k(){if(v())return!0;try{return await g()}catch{return!1}}export{k as checkCivicConnection,B as loadLiveDashboardData};
